name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  validate:
    name: Validate Plugin Structure
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check plugin.json exists
        run: |
          for plugin_dir in plugins/*/; do
            if [ -d "$plugin_dir" ]; then
              plugin_name=$(basename "$plugin_dir")
              plugin_json="${plugin_dir}.claude-plugin/plugin.json"

              if [ ! -f "$plugin_json" ]; then
                echo "ERROR: Missing plugin.json for $plugin_name"
                exit 1
              fi

              echo "✓ Found plugin.json for $plugin_name"
            fi
          done

      - name: Validate plugin.json syntax
        run: |
          for plugin_json in plugins/*/.claude-plugin/plugin.json; do
            if [ -f "$plugin_json" ]; then
              if ! python3 -c "import json; json.load(open('$plugin_json'))"; then
                echo "ERROR: Invalid JSON in $plugin_json"
                exit 1
              fi
              echo "✓ Valid JSON: $plugin_json"
            fi
          done

      - name: Check version format (semver)
        run: |
          for plugin_json in plugins/*/.claude-plugin/plugin.json; do
            if [ -f "$plugin_json" ]; then
              version=$(python3 -c "import json; print(json.load(open('$plugin_json')).get('version', ''))")
              plugin_name=$(dirname "$plugin_json" | xargs dirname | xargs basename)

              if [ -z "$version" ]; then
                echo "ERROR: Missing version in $plugin_name"
                exit 1
              fi

              # Check semver format (X.Y.Z)
              if ! echo "$version" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+$'; then
                echo "ERROR: Invalid semver version '$version' in $plugin_name (expected X.Y.Z)"
                exit 1
              fi

              echo "✓ Valid version $version for $plugin_name"
            fi
          done

  marketplace-sync:
    name: Marketplace Sync
    runs-on: ubuntu-latest
    needs: [validate]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate marketplace versions
        run: |
          echo "Checking marketplace.json version sync..."

          errors=0
          marketplace_file=".claude-plugin/marketplace.json"

          # Check marketplace.json exists
          if [ ! -f "$marketplace_file" ]; then
            echo "ERROR: $marketplace_file not found"
            exit 1
          fi

          echo ""
          echo "Plugin Version Comparison:"
          echo "=========================="
          printf "%-25s %-15s %-15s %s\n" "PLUGIN" "PLUGIN.JSON" "MARKETPLACE" "STATUS"
          echo "---------------------------------------------------------------------------"

          # Iterate over all plugins
          for plugin_dir in plugins/*/; do
            if [ -d "$plugin_dir" ]; then
              plugin_name=$(basename "$plugin_dir")
              plugin_json="${plugin_dir}.claude-plugin/plugin.json"

              # Get actual version from plugin.json
              if [ ! -f "$plugin_json" ]; then
                echo "ERROR: Missing $plugin_json"
                errors=$((errors + 1))
                continue
              fi

              actual_version=$(jq -r '.version' "$plugin_json")

              # Get marketplace version
              marketplace_version=$(jq -r --arg name "$plugin_name" '.plugins[] | select(.name == $name) | .version' "$marketplace_file")

              if [ -z "$marketplace_version" ] || [ "$marketplace_version" = "null" ]; then
                printf "%-25s %-15s %-15s %s\n" "$plugin_name" "$actual_version" "MISSING" "FAIL"
                echo "  -> Plugin '$plugin_name' not found in marketplace.json"
                errors=$((errors + 1))
              elif [ "$actual_version" != "$marketplace_version" ]; then
                printf "%-25s %-15s %-15s %s\n" "$plugin_name" "$actual_version" "$marketplace_version" "FAIL"
                echo "  -> Version mismatch: expected $actual_version, got $marketplace_version"
                errors=$((errors + 1))
              else
                printf "%-25s %-15s %-15s %s\n" "$plugin_name" "$actual_version" "$marketplace_version" "OK"
              fi
            fi
          done

          echo ""
          if [ $errors -gt 0 ]; then
            echo "FAILED: $errors version sync error(s) found"
            echo ""
            echo "To fix: Update .claude-plugin/marketplace.json to match plugin versions"
            exit 1
          fi

          echo "SUCCESS: All plugin versions in sync"

  version-bump-check:
    name: Version Bump Check
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    steps:
      - name: Checkout PR
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for version bumps on changed plugins
        run: |
          # Get list of changed files
          changed_files=$(git diff --name-only origin/main...HEAD)

          # Find which plugins were modified
          modified_plugins=""
          for file in $changed_files; do
            if [[ "$file" == plugins/* ]]; then
              plugin_name=$(echo "$file" | cut -d'/' -f2)
              if [[ ! " $modified_plugins " =~ " $plugin_name " ]]; then
                modified_plugins="$modified_plugins $plugin_name"
              fi
            fi
          done

          # For each modified plugin, check if version was bumped
          for plugin_name in $modified_plugins; do
            plugin_json="plugins/$plugin_name/.claude-plugin/plugin.json"

            if [ -f "$plugin_json" ]; then
              # Get current version
              current_version=$(python3 -c "import json; print(json.load(open('$plugin_json')).get('version', ''))")

              # Get base version from main
              base_version=$(git show origin/main:$plugin_json 2>/dev/null | python3 -c "import json,sys; print(json.load(sys.stdin).get('version', ''))" 2>/dev/null || echo "0.0.0")

              if [ "$current_version" = "$base_version" ]; then
                echo "WARNING: Plugin '$plugin_name' was modified but version was not bumped"
                echo "  Current version: $current_version"
                echo "  Consider bumping the version in $plugin_json"
              else
                echo "✓ Plugin '$plugin_name' version bumped: $base_version -> $current_version"
              fi
            fi
          done

  validate-hooks:
    name: Validate Hook Scripts
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check shell script syntax
        run: |
          errors=0
          for sh_file in $(find plugins -name "*.sh" -type f); do
            if bash -n "$sh_file" 2>/dev/null; then
              echo "✓ Syntax OK: $sh_file"
            else
              echo "ERROR: Syntax error in $sh_file"
              bash -n "$sh_file"
              errors=$((errors + 1))
            fi
          done

          if [ $errors -gt 0 ]; then
            echo "FAILED: $errors shell script(s) with syntax errors"
            exit 1
          fi
          echo "SUCCESS: All shell scripts pass syntax check"

      - name: Check hook scripts are executable
        run: |
          errors=0
          for plugin_dir in plugins/*/; do
            hooks_dir="${plugin_dir}hooks"
            if [ -d "$hooks_dir" ]; then
              for sh_file in "$hooks_dir"/*.sh; do
                if [ -f "$sh_file" ] && [ ! -x "$sh_file" ]; then
                  echo "ERROR: Hook script not executable: $sh_file"
                  errors=$((errors + 1))
                else
                  echo "✓ Executable: $sh_file"
                fi
              done
            fi
          done

          if [ $errors -gt 0 ]; then
            echo "FAILED: $errors hook script(s) not executable"
            exit 1
          fi
          echo "SUCCESS: All hook scripts are executable"

      - name: Validate hooks.json
        run: |
          errors=0
          for plugin_dir in plugins/*/; do
            plugin_name=$(basename "$plugin_dir")
            plugin_json="${plugin_dir}.claude-plugin/plugin.json"
            hooks_ref=$(jq -r '.hooks // empty' "$plugin_json" 2>/dev/null)

            if [ -n "$hooks_ref" ]; then
              hooks_file="${plugin_dir}${hooks_ref}"
              if [ ! -f "$hooks_file" ]; then
                echo "ERROR: $plugin_name plugin.json references $hooks_ref but file not found"
                errors=$((errors + 1))
                continue
              fi

              if ! python3 -c "import json; json.load(open('$hooks_file'))"; then
                echo "ERROR: Invalid JSON in $hooks_file"
                errors=$((errors + 1))
                continue
              fi

              echo "✓ Valid hooks.json for $plugin_name"

              # Check that referenced command scripts exist
              for cmd in $(jq -r '.. | .command? // empty' "$hooks_file"); do
                # Replace ${CLAUDE_PLUGIN_ROOT} with plugin dir for local check
                local_path=$(echo "$cmd" | sed "s|\\\${CLAUDE_PLUGIN_ROOT}|${plugin_dir%/}|g")
                if [ ! -f "$local_path" ]; then
                  echo "ERROR: Hook command not found: $cmd (resolved to $local_path)"
                  errors=$((errors + 1))
                else
                  echo "  ✓ Hook command exists: $cmd"
                fi
              done
            fi
          done

          if [ $errors -gt 0 ]; then
            echo "FAILED: $errors hooks.json error(s)"
            exit 1
          fi
          echo "SUCCESS: All hooks.json files validated"

      - name: Validate phase prompt templates
        run: |
          errors=0
          for plugin_dir in plugins/*/; do
            phases_dir="${plugin_dir}prompts/phases"
            if [ -d "$phases_dir" ]; then
              plugin_name=$(basename "$plugin_dir")
              for template in "$phases_dir"/*.md; do
                if [ -f "$template" ]; then
                  filename=$(basename "$template")
                  # Extract expected phase ID from filename (e.g., "1.2-plan.md" → "1.2")
                  phase_id=$(echo "$filename" | sed 's/-.*//')

                  if ! grep -q "\[PHASE $phase_id\]" "$template"; then
                    echo "ERROR: $template missing [PHASE $phase_id] tag"
                    errors=$((errors + 1))
                  else
                    echo "✓ Phase tag found: $template"
                  fi
                fi
              done
            fi
          done

          if [ $errors -gt 0 ]; then
            echo "FAILED: $errors phase template(s) missing tags"
            exit 1
          fi
          echo "SUCCESS: All phase templates have correct tags"

  lint-markdown:
    name: Lint Markdown
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check markdown syntax
        run: |
          # Simple check for markdown files
          error_count=0
          for md_file in $(find plugins -name "*.md" -type f); do
            # Check for common issues
            if grep -qE '^\s{1,3}[*+-]' "$md_file"; then
              echo "WARNING: Inconsistent list indentation in $md_file"
            fi

            # Check frontmatter for command files
            if [[ "$md_file" == */commands/*.md ]]; then
              if ! head -1 "$md_file" | grep -q '^---$'; then
                echo "ERROR: Missing frontmatter in command file $md_file"
                error_count=$((error_count + 1))
              fi
            fi
          done

          if [ $error_count -gt 0 ]; then
            echo "Found $error_count errors"
            exit 1
          fi

          echo "✓ All markdown files validated"

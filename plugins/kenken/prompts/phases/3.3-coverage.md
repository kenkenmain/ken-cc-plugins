# Phase 3.3: Coverage [PHASE 3.3]

## Subagent Config

- **Type:** Bash (command phase)
- **Input:** config coverage commands
- **Output:** `.agents/tmp/kenken/phases/3.3-coverage.json`

## Instructions

Run test coverage analysis and verify it meets the configured threshold. This is a Bash command phase.

### Process

1. Read coverage command from config (`stages.test.coverageCommand`)
2. Read coverage threshold from config (`stages.test.coverageThreshold`, default: 80%)
3. Run coverage command
4. Parse coverage report output
5. Compare against threshold
6. Log coverage to `.agents/logs/coverage-{timestamp}.log`
7. Write results to output file

### Coverage Commands by Framework

If not configured, use the auto-detected command:

| Framework | Coverage Command |
| --------- | ---------------- |
| Jest | `npx jest --coverage --coverageReporters=text` |
| Vitest | `npx vitest run --coverage` |
| pytest | `pytest --cov --cov-report=term` |
| go test | `go test -cover ./...` |
| cargo test | `cargo tarpaulin` |

### Threshold Evaluation

- If coverage >= threshold: pass, proceed to next phase
- If coverage < threshold: fail, return to Phase 3.2 to add more tests

### Ensure Log Directory

```bash
mkdir -p .agents/logs
```

## Output Format

Write to `.agents/tmp/kenken/phases/3.3-coverage.json`:

```json
{
  "coveragePercent": 85.2,
  "threshold": 80,
  "passed": true,
  "command": "npx jest --coverage",
  "details": {
    "statements": 87.1,
    "branches": 82.3,
    "functions": 91.0,
    "lines": 85.2
  },
  "uncoveredFiles": [
    { "file": "src/example.ts", "coverage": 45.0 }
  ],
  "logFile": ".agents/logs/coverage-{timestamp}.log"
}
```

### On Failure

If coverage < threshold:

1. Identify uncovered files and lines
2. Return to Phase 3.2 to write additional tests targeting uncovered paths
3. Re-run coverage after new tests are written

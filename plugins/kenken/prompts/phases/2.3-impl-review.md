# Phase 2.3: Implementation Review [PHASE 2.3]

## Subagent Config

- **Type:** kenken:codex-reviewer (uses codex-high MCP)
- **Input:** `.agents/tmp/kenken/phases/1.2-plan.md`, git diff
- **Output:** `.agents/tmp/kenken/phases/2.3-impl-review.json`

## Instructions

Review implementation against the plan using Codex MCP. Route through `kenken:codex-reviewer` agent.

### Process

1. Get list of modified files from `.agents/tmp/kenken/phases/2.1-tasks.json`
2. Gather git diff of all changes
3. Dispatch to Codex MCP (codex-high) with implementation review criteria
4. Write review result to output file

### Codex Dispatch

```
mcp__codex-high__codex(
  prompt: "Review implementation. Plan: .agents/tmp/kenken/phases/1.2-plan.md. Modified files: [list from 2.1-tasks.json]. Git diff attached. Return JSON with status, issues[], filesReviewed, summary.",
  cwd: "{project dir}"
)
```

### Review Criteria

**HIGH — immediate fix required:**

- Logic bugs: wrong output, incorrect conditions, off-by-one errors
- Unhandled exceptions: system crashes on foreseeable input
- Security vulnerabilities: OWASP Top 10 (injection, XSS, auth bypass, path traversal)
- Data corruption or loss scenarios
- Resource leaks: memory, file handles, connections
- Race conditions: concurrent access without synchronization
- Breaking changes without migration path

**MEDIUM — should fix before advancing:**

- Missing input validation on external boundaries
- Error messages leaking internal details or secrets
- Insufficient logging for production debugging
- N+1 queries or performance anti-patterns
- Fragile code: works now but breaks on minor changes
- Missing null/undefined checks

**LOW — note for improvement:**

- Style inconsistencies with codebase conventions
- Naming that doesn't follow project patterns
- Missed refactoring opportunities

### Security Checklist

- [ ] SQL injection — parameterized queries used?
- [ ] XSS — output escaped?
- [ ] Command injection — user input reaches shell?
- [ ] Path traversal — user input in file paths?
- [ ] Auth bypass — all endpoints protected?
- [ ] Authorization — permission checks present?
- [ ] Secrets in logs — credentials exposed?

### Bug Fixer

If issues are found, fix using configured bug fixer (config `stages.implement.implementReview.bugFixer`):

- `claude`: Use Claude subagents to fix issues
- `codex-high` (default): Use `mcp__codex-high__codex` to fix issues
- `codex-xhigh`: Use `mcp__codex-xhigh__codex` to fix issues

## Output Format

Write Codex response as JSON to `.agents/tmp/kenken/phases/2.3-impl-review.json`:

```json
{
  "status": "approved" | "needs_revision",
  "issues": [
    {
      "severity": "HIGH" | "MEDIUM" | "LOW",
      "description": "...",
      "location": "file:line",
      "casualtyScenario": "how this fails in production",
      "fix": "specific remediation"
    }
  ],
  "filesReviewed": ["..."],
  "summary": "..."
}
```

### If Issues Found

If status is `needs_revision`:

1. Fix issues using configured bugFixer
2. Re-run review (increment retryCount)
3. Repeat until approved or max retries

On max retries exceeded: restart IMPLEMENT stage.

ANY HIGH issue = requires revision. Fix everything before advancing.

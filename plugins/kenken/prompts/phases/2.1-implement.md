# Phase 2.1: Implement [PHASE 2.1]

## Subagent Config

- **Type:** kenken:task-agent (wave-based parallel batch)
- **Input:** `.agents/tmp/kenken/phases/1.2-plan.md`
- **Output:** `.agents/tmp/kenken/phases/2.1-tasks.json`

## Instructions

Execute implementation tasks from the plan in dependency-ordered waves. Model selection per task is based on complexity scoring.

### Process

1. Read `.agents/tmp/kenken/phases/1.2-plan.md`
2. Parse the `tasks:` YAML block into task list
3. Score each task complexity (easy/medium/hard)
4. Build dependency graph
5. Dispatch tasks in waves:
   - Wave 1: tasks with no dependencies (parallel)
   - Wave 2: tasks whose deps are complete (parallel)
   - Continue until all done

### Complexity Scoring

| Level  | Criteria                            | Execution                            |
| ------ | ----------------------------------- | ------------------------------------ |
| Easy   | 1 file, <50 LOC                     | kenken:task-agent (sonnet)           |
| Medium | 2-3 files, 50-200 LOC              | kenken:task-agent (opus)             |
| Hard   | 4+ files, >200 LOC, security/concurrency | kenken:codex-reviewer (codex-xhigh)  |

### Implementer Selection

Check config `stages.implement.implementation.implementer`:

- `claude` (default): Use Claude subagents via Task tool
- `codex-high`: Use `mcp__codex-high__codex` for implementation
- `codex-xhigh`: Use `mcp__codex-xhigh__codex` for implementation

### Task Agent Payload (Claude mode, easy/medium)

```json
{
  "taskId": "task-N",
  "description": "...",
  "targetFiles": ["..."],
  "instructions": "...",
  "dependencyOutputs": ["..."],
  "constraints": {
    "maxReadFiles": 10,
    "maxWriteFiles": 3,
    "allowBashCommands": false
  }
}
```

### Implementation Standards

**Error Handling:**
- Every operation that can fail has explicit handling
- Errors logged with full context (message, stack, surrounding state)
- Errors propagate correctly — swallowed errors become invisible failures
- Recovery paths defined, not just detection

**Logging:**
- Detect repo's logging library (winston, pino, console, etc.)
- Function entry for key operations
- All errors with stack traces and context
- Warnings for anomalies
- State changes logged
- Use repo patterns for consistency

**Input Validation:**
- Validate all external input — every character, every byte, every field
- Fail fast with clear messages
- Trust nothing from outside

**Security:**
- No hardcoded secrets
- Parameterized queries always
- Escape output
- Least privilege

### After Each Task

Verify:
- [ ] Code runs without errors
- [ ] All error paths handled
- [ ] Logging sufficient for debugging
- [ ] No security vulnerabilities
- [ ] Follows repo conventions
- [ ] Edge cases handled

## Output Format

Write to `.agents/tmp/kenken/phases/2.1-tasks.json`:

```json
{
  "waves": [
    {
      "waveNumber": 1,
      "tasks": [
        { "id": "task-1", "status": "completed", "summary": "..." }
      ]
    }
  ],
  "completedTasks": ["task-1"],
  "failedTasks": []
}
```

### Error Handling

Failed tasks: mark as failed, skip blocked dependents, continue with others. Report all failures in output.

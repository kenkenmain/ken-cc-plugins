# Phase 4.1: Final Review [PHASE 4.1]

## Subagent Config

- **Type:** kenken:codex-reviewer (uses codex-xhigh MCP)
- **Input:** all `.agents/tmp/kenken/phases/*.json`
- **Output:** `.agents/tmp/kenken/phases/4.1-final-review.json`

## Instructions

Perform final holistic review using the highest reasoning tier. This is the last checkpoint before completion. Route through `kenken:codex-reviewer` agent with `codex-xhigh`.

### Process

1. Gather all phase outputs from `.agents/tmp/kenken/phases/`
2. Dispatch to Codex MCP (codex-xhigh) with final review criteria
3. If HIGH severity issues found, fix using configured bugFixer
4. Re-run if significant changes made
5. Write review result to output file

### Codex Dispatch

```
mcp__codex-xhigh__codex(
  prompt: "Final review of all changes. Plan: .agents/tmp/kenken/phases/1.2-plan.md. Tasks: .agents/tmp/kenken/phases/2.1-tasks.json. Tests: .agents/tmp/kenken/phases/3.4-test-results.json (if exists). All phase outputs in .agents/tmp/kenken/phases/. Return JSON with status, overallQuality, issues[], metrics, summary, readyForCompletion.",
  cwd: "{project dir}"
)
```

### Review Scope

Don't trust previous reviews. Read every change fresh.

**Correctness:**
- Does it actually work under all conditions?
- Logic errors? Off-by-one, sign errors, wrong conditions?
- Edge cases all handled?
- Race conditions addressed?

**Security:**
- Can bad input cause damage?
- Secrets protected?
- Auth/authz correct?
- What would an attacker try?

**Reliability:**
- What happens when dependencies fail?
- Errors handled or does the system enter undefined state?
- Logging sufficient for production debugging?
- Recovery possible or is failure terminal?

**Maintainability:**
- Will the next engineer understand this?
- Hidden assumptions documented?
- Unnecessary complexity removed?

### Severity

**HIGH:** Guaranteed production failure. Fix or do not proceed.

**MEDIUM:** Probable production issue. The conditions that trigger it are likely.

**LOW:** Eventual maintenance burden. Timeline to problem lengthens but doesn't disappear.

### Bug Fixer

Fix HIGH severity issues using configured bug fixer (config `stages.final.codexFinal.bugFixer`):

- `claude`: Use Claude subagents to fix issues
- `codex-high` (default): Use `mcp__codex-high__codex` to fix issues
- `codex-xhigh`: Use `mcp__codex-xhigh__codex` to fix issues

## Output Format

Write Codex response as JSON to `.agents/tmp/kenken/phases/4.1-final-review.json`:

```json
{
  "status": "approved" | "blocked",
  "overallQuality": "high" | "medium" | "low",
  "issues": [
    {
      "severity": "HIGH" | "MEDIUM" | "LOW",
      "description": "...",
      "location": "file:line",
      "casualtyScenario": "how this fails in production",
      "requiredFix": "specific remediation"
    }
  ],
  "metrics": {
    "filesReviewed": 0,
    "issuesFound": 0,
    "highSeverity": 0,
    "mediumSeverity": 0,
    "lowSeverity": 0
  },
  "preDeployChecklist": {
    "allIssuesFixed": true,
    "errorHandlingComplete": true,
    "loggingSufficient": true,
    "noSecurityVulnerabilities": true,
    "codeMatchesDocs": true
  },
  "summary": "...",
  "readyForCompletion": true
}
```

### Decision

- `approved` + `readyForCompletion: true` -> proceed to extensions phase
- `blocked` -> halt workflow, report to user

Exit criteria: No HIGH severity issues remaining.

# Phase 4.3: Completion [PHASE 4.3]

## Subagent Config

- **Type:** Bash (single subagent)
- **Input:** `.agents/tmp/kenken/phases/4.2-extensions.json`
- **Output:** `.agents/tmp/kenken/phases/4.3-completion.json`

## Instructions

Finalize the workflow with optional git/PR operations. Ask the user which git workflow to use, then execute accordingly.

### Process

1. Read extensions result from `.agents/tmp/kenken/phases/4.2-extensions.json`
2. Ask user using AskUserQuestion (header: "Git workflow"):
   - **No git** — Complete without git operations
   - **Commit only** — Commit to current branch
   - **Branch + PR** — Create feature branch and open PR
3. Execute the chosen git workflow
4. Write completion result to output file
5. Clear state file

### Git Workflow: No Git

1. Summarize what was accomplished
2. Clear state file (`.agents/tmp/kenken/state.json`)
3. Done

### Git Workflow: Commit Only

1. Stage all relevant files:
   ```bash
   git add -A
   git reset -- .agents/ docs/plans/ *.tmp *.log
   ```
2. Generate commit message from task description
3. Commit with co-author:
   ```bash
   git commit -m "<message>

   Co-Authored-By: Claude <noreply@anthropic.com>"
   ```
4. Summarize and clear state

### Git Workflow: Branch + PR

1. Generate branch name using configured format:
   - Format from config: `git.branchFormat` (default: `{type}/{slug}`)
   - Placeholders: `{type}` (feat/fix/etc), `{slug}` (task-slug), `{date}` (YYYY-MM-DD), `{user}` (git user)
   - Type from config: `git.defaultType` (default: `feat`), or infer from task
   - Example: `feat/add-user-auth`, `fix/login-bug`

2. Fetch latest main and create branch:
   ```bash
   git fetch origin
   MAIN_BRANCH=$(git remote show origin | grep 'HEAD branch' | awk '{print $NF}')
   git stash --include-untracked
   git checkout -b <branch-name> origin/$MAIN_BRANCH
   git stash pop
   ```

3. Stage and commit (same as "Commit only" above)

4. Push branch:
   ```bash
   git push -u origin <branch-name>
   ```

5. Create PR:
   ```bash
   gh pr create --title "<task summary>" --body "$(cat <<'EOF'
   ## Summary
   <bullet points from task>

   ## Changes
   <list of changed files>

   Generated with kenken workflow
   EOF
   )"
   ```

6. Display PR URL
7. Summarize and clear state

### Files to Exclude from Staging

Always exclude from git operations:
- `.agents/**` — runtime state
- `docs/plans/**` — design documents
- `*.tmp` — temporary files
- `*.log` — log files

## Output Format

Write to `.agents/tmp/kenken/phases/4.3-completion.json`:

```json
{
  "status": "completed",
  "gitWorkflow": "none" | "commit" | "branch+pr",
  "branch": "feat/task-name",
  "commit": "abc1234",
  "pr": {
    "number": 42,
    "url": "https://github.com/..."
  },
  "summary": "..."
}
```

Note: `branch`, `commit`, and `pr` fields are null when `gitWorkflow` is `"none"`. The `pr` field is null when `gitWorkflow` is `"commit"`.

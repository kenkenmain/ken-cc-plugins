# Phase 3.4: Run Tests [PHASE 3.4]

## Subagent Config

- **Type:** Bash (command phase)
- **Input:** config test commands
- **Output:** `.agents/tmp/kenken/phases/3.4-test-results.json`

## Instructions

Execute the full test suite (lint + tests), capture results, and classify any failures. This is a Bash command phase.

### Process

1. Read lint command from config (`stages.test.lintCommand`, if specified)
2. Read test command from config (`stages.test.testCommand`)
3. Run lint command (if available)
4. Run test command
5. Capture exit codes, stdout, stderr for each
6. Extract errors to `.agents/logs/errors/`
7. Generate `error-summary.json`
8. Write results to output file

### Ensure Log Directories

```bash
mkdir -p .agents/logs/errors
```

### Error Classification

On test failure, classify the error by location:

| Error Location                    | Error Type       | Action                                    |
| --------------------------------- | ---------------- | ----------------------------------------- |
| In test file (`*.test.*`, `*.spec.*`) | Test Error       | Return to Phase 3.2 (fix tests)           |
| In source file (`src/*`, `lib/*`)     | Code Logic Error | Fix code, then restart IMPLEMENT stage    |

### Error Summary Format

Write to `.agents/logs/errors/error-summary.json`:

```json
{
  "totalErrors": 2,
  "errors": [
    {
      "file": "src/example.ts",
      "line": 42,
      "type": "code_logic",
      "message": "TypeError: Cannot read property...",
      "test": "example.test.ts:15"
    }
  ]
}
```

## Output Format

Write to `.agents/tmp/kenken/phases/3.4-test-results.json`:

```json
{
  "lint": {
    "exitCode": 0,
    "command": "make lint",
    "stdout": "...",
    "stderr": ""
  },
  "test": {
    "exitCode": 0,
    "command": "make test",
    "stdout": "...",
    "stderr": ""
  },
  "allPassed": true,
  "failureClassification": null,
  "logFile": ".agents/logs/test-run-{timestamp}.log"
}
```

### On Failure

If `allPassed: false`:

- **Test errors** (error in test files): Return to Phase 3.2 to fix tests
- **Code logic errors** (error in source files): Mark test phase as blocked, restart IMPLEMENT stage to fix the code, then return to TEST stage
- DO NOT try to fix code logic errors in the test phase

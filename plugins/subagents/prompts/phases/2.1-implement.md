# Phase 2.1: Implement [PHASE 2.1]

## Subagent Config

- **Type:** task-agent (wave-based parallel batch)
- **Input:** `.agents/tmp/phases/1.2-plan.md`
- **Output:** `.agents/tmp/phases/2.1-tasks.json`

## Instructions

Execute implementation tasks from the plan in dependency-ordered waves.

### Process

1. Read `.agents/tmp/phases/1.2-plan.md`
2. Parse tasks and build dependency graph
3. Score each task complexity (easy/medium/hard)
4. Dispatch tasks in waves:
   - Wave 1: tasks with no dependencies (parallel)
   - Wave 2: tasks whose deps are complete (parallel)
   - Continue until all done
5. After all waves complete, aggregate test data:
   - Count total tests across all tasks (`testsTotal`)
   - Collect unique test file paths (`testFiles`)
   - Add `waveSummary` to each wave with completion and test counts

### Complexity Scoring

| Level  | Criteria                     | Execution                    |
| ------ | ---------------------------- | ---------------------------- |
| Easy   | 1 file, <50 LOC              | task-agent → codex-high      |
| Medium | 2-3 files, 50-200 LOC        | task-agent → codex-high      |
| Hard   | 4+ files, >200 LOC, security | task-agent → codex-high      |

### Task Agent Payload (easy/medium)

```json
{"taskId":"task-N","description":"...","targetFiles":[...],"instructions":"...","dependencyOutputs":[...],"constraints":{"allowBashCommands":false}}
```

Task agents are expected to write unit tests alongside their implementation. The `testsWritten` array in each task's output tracks what tests were produced. Tasks that cannot write meaningful tests (e.g., configuration-only changes) should return an empty `testsWritten: []`.

### Output Format

Write to `.agents/tmp/phases/2.1-tasks.json`:

```json
{
  "waves": [
    {
      "waveNumber": 1,
      "tasks": [
        {
          "id": "task-1",
          "status": "completed",
          "summary": "...",
          "testsWritten": [
            { "file": "src/__tests__/example.test.ts", "targetFile": "src/example.ts", "testCount": 5 }
          ]
        }
      ],
      "waveSummary": { "tasksCompleted": 1, "tasksFailed": 0, "testsWritten": 1 }
    }
  ],
  "completedTasks": ["task-1"],
  "failedTasks": [],
  "testsTotal": 5,
  "testFiles": ["src/__tests__/example.test.ts"]
}
```

### Error Handling

Failed tasks: mark as failed, skip blocked dependents, continue with others.

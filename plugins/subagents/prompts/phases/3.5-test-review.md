# Phase 3.5: Test Review [PHASE 3.5]

## Subagent Config

- **Type:** `state.reviewer` (codex-reviewer or claude-reviewer)
- **Criteria:** `prompts/high-stakes/test-review.md`
- **Input:** `.agents/tmp/phases/3.1-test-results.json`, `.agents/tmp/phases/3.2-analysis.md`, `.agents/tmp/phases/3.3-test-dev.json`
- **Output:** `.agents/tmp/phases/3.5-test-review.json`

## Instructions

Final review of the entire TEST stage — all test results, analysis, and developed tests. Includes coverage threshold check.

### Process

1. Read the review criteria from `prompts/high-stakes/test-review.md`
2. Read test results from `.agents/tmp/phases/3.1-test-results.json`
3. Read failure analysis from `.agents/tmp/phases/3.2-analysis.md`
4. Read test development results from `.agents/tmp/phases/3.3-test-dev.json`
5. **Run test suite with coverage** to get current coverage numbers:
   ```bash
   make test-coverage 2>&1 || npm run test -- --coverage 2>&1 || pytest --cov 2>&1
   ```
6. **Check coverage against threshold** (`state.coverageThreshold`, default 90%)
7. Evaluate overall test quality, coverage, and CI completeness against every criterion
8. Write structured JSON result to `.agents/tmp/phases/3.5-test-review.json`

### Output

Write JSON to `.agents/tmp/phases/3.5-test-review.json`:

```json
{
  "status": "approved | needs_coverage | blocked",
  "coverage": {
    "current": 87.3,
    "threshold": 90,
    "met": false
  },
  "issues": [],
  "summary": "..."
}
```

### Decision

- `approved` + `coverage.met: true` → proceed to FINAL stage
- `needs_coverage` + `coverage.met: false` → **loop back to Phase 3.3** (SubagentStop hook handles this)
- `blocked` (quality issues unrelated to coverage) → enter review-fix cycle as normal

The SubagentStop hook reads `coverage.met` from the output. If `false`, it sets `state.coverageLoop` and resets `currentPhase` to `"3.3"` for another iteration of test development. This continues until coverage is met or `coverageLoop.maxIterations` (default: 20) is reached.
